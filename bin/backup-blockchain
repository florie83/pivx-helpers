#!/bin/bash

set -e

function isDaemonRunning() {
  [[ $(pgrep -x 'pivxd') ]]
}

function makeBlockchainTar() {
  local timestamp=`date +"%d:%m:%Y_%T_%Z"`

  local tarname='blockchain_backup_'$timestamp'.tar.gz'

  tar -zcv --force-local \
  --exclude '**/*LOG*' \
  --exclude '**/*LOCK' \
  -f $tarname ~/.pivx/blocks ~/.pivx/chainstate

  sha256sum $tarname
}

####

wasRunning=false

if isDaemonRunning; then
  echo 'stopping pivxd'
  pivx-cli stop
  wasRunning=true
else
  echo 'pivxd is not running'
fi

while isDaemonRunning; do
  sleep 1
  echo 'waiting for pivxd to stop'
done

if [ $wasRunning ]; then
  echo 'pivxd stopped'
fi

makeBlockchainTar

exit 0
